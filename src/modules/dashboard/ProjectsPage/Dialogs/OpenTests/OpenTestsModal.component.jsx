import { OPEN_TEST_HEADINGS } from '@/constants/project';
import { formatDate } from '@/electron/lib/utils';
import Chip from '@/modules/core/Chip';
import Dialog from '@/modules/core/Dialog';
import Icon from '@/modules/core/Icon';
import Search from '@/modules/core/Search/Search.component';
import Table from '@/modules/core/Table';
import TablePagination from '@/modules/core/TablePagination';
import { Stack, Typography } from '@mui/material';
import { useEffect, useRef, useState } from 'react';
import { CloseTest, DuplicateTest, EditTest } from '../ProjectTest';
import style from './OpenTestsModal.module.scss';
import { circlePlus, fileXmark, folderOpen, copy, edit, share } from '@/assets/icons';

const StatusChip = ({ status }) => {
  const LABELS = {
    OPENED: { label: 'Opened' },
    IN_PROGRESS: { label: 'In progress', type: 'info' },
    TEST_COMPLETED: { label: 'In progress', type: 'info' },
    TEST_FAILED: { label: 'In progress', type: 'info' },
    COMPLETED: { label: 'Completed', type: 'success' },
    FAILED: { label: 'Failed', type: 'error' },
    CLOSED: { label: 'Closed', type: 'disabled' }
  };
  const { label, type } = LABELS[status];
  return <Chip label={label} type={type} />;
};

const prepareRows = (tests) => {
  return tests.map(test => ({
    id: test.id,
    status: test.status,
    items: [
      {
        component: (
          <Stack direction='row' alignItems='center' spacing={2}>
            <Typography whiteSpace='nowrap'>{test.name}</Typography>
            <Chip label={test.environment.name.toUpperCase()} />
          </Stack>
        ),
        props: { component: 'th' }
      },
      { label: formatDate(test.start_date) },
      { label: formatDate(test.end_date) },
      { component: <StatusChip status={test.status} /> }
    ]
  }));
};

const OpenTestsModal = ({ open, onClose, project, onTestOpen, triggerEl }) => {
  const firstRowRef = useRef(null);

  const [inputValue, setInputValue] = useState('');
  const [tests, setTests] = useState([]);
  const [meta, setMeta] = useState({});
  const [filter, setFilter] = useState({});
  const [pagination, setPagination] = useState({});
  const [isEditTestDialogOpen, setIsEditTestDialogOpen] = useState(false);
  const [isDuplicateTestDialogOpen, setIsDuplicateTestDialogOpen] = useState(false);
  const [isCloseTestDialogOpen, setIsCloseTestDialogOpen] = useState(false);
  const [selectedTestId, setSelectedTestId] = useState(null);
  const [isLoading, setIsLoading] = useState(false);

  const getTests = async (filter) => {
    if (!project) return;
    setIsLoading(true);
    const res = await window.api.environmentTest.find({ ...filter, ...pagination, project_id: project.id }, { detailed: true });
    setTests(res.result);
    setMeta(res.meta);
    setIsLoading(false);
  };

  const refreshTests = async () => {
    setFilter({});
    await getTests();
  };

  useEffect(() => {
    getTests(filter);
  }, [filter, project, pagination]);

  const handleSearch = (value) => {
    if (value) {
      setFilter({ ...filter, search: value });
    } else {
      setFilter({ ...filter, search: undefined });
    }
  };

  const handleSort = (field, direction) => {
    setFilter(prev => ({
      ...prev,
      sort: {
        field,
        direction
      }
    }));
  };

  const onTestDuplicated = (test) => {
    refreshTests();
    if (test) {
      onTestOpen(test);
    }
  };

  const handleRowClick = (row) => {
    if (row.status === 'CLOSED') {
      return;
    }
    onTestOpen(row.id);
  };

  const actionItems = [
    {
      label: 'Open test',
      icon: folderOpen,
      onClick: (row) => {
        onTestOpen(row.id);
      },
      isOptionRemoved: row => row.status !== 'CLOSED'
    },
    {
      label: 'Edit test',
      icon: edit,
      onClick: (row) => {
        setIsEditTestDialogOpen(true);
        setSelectedTestId(row.id);
      }
    },
    {
      label: 'Duplicate test',
      icon: copy,
      onClick: (row) => {
        setIsDuplicateTestDialogOpen(true);
        setSelectedTestId(row.id);
      }
    },
    {
      label: 'Close test',
      icon: fileXmark,
      onClick: (row) => {
        setIsCloseTestDialogOpen(true);
        setSelectedTestId(row.id);
      },
      isOptionRemoved: row => ['TEST_COMPLETED', 'PASS'].includes(row.status)
    },
    {
      label: 'Reopen test',
      icon: share,
      onClick: async (row) => {
        setIsLoading(true);
        await window.api.environmentTest.openClosedTest({ id: row.id });
        await refreshTests();
        setIsLoading(false);
      },
      isOptionRemoved: row => row.status === 'CLOSED'
    }
  ];

  return (
    <>
      <Dialog
        open={open}
        onClose={onClose}
        title='Open Test'
        titleIcon={<Icon icon={circlePlus} shadowSize={8} className={style.icon} showShadow={true} />}
        className={style.root}
        dialogHeaderClassName={style.dialogHeader}
        dialogContentClassName={style.dialogContent}
        dialogActionsClassName={style.dialogActions}
        dialogContainerClassName={style.dialogContainer}
        dialogContentContainer={style.contentWrapper}
        dialogFormClassName={style.form}
        maxWidth='lg'
        fullWidth
        PaperProps={{
          style: {
            borderRadius: '12px'
          }
        }}
        triggerEl={triggerEl}
      >
        <Search
          value={inputValue}
          setValue={setInputValue}
          className={style.search}
          onSearch={handleSearch}
        />
        <Table
          isLoading={isLoading}
          headings={OPEN_TEST_HEADINGS}
          rows={prepareRows(tests)}
          ariaLabel='open test'
          sortable
          onSort={handleSort}
          actionItems={actionItems}
          maxHeight='calc(100vh - 300px)'
          onClick={handleRowClick}
          firstRowRef={firstRowRef}
        />
        <TablePagination
          disabled={isLoading}
          meta={meta}
          filter={pagination}
          onChange={setPagination}
          className={style.tablePagination}
          firstRowRef={firstRowRef}
        />
      </Dialog>
      {isEditTestDialogOpen && (
        <EditTest open={isEditTestDialogOpen} onClose={() => setIsEditTestDialogOpen(false)} testId={selectedTestId} project={project} onTestUpdated={refreshTests} />
      )}
      {isDuplicateTestDialogOpen && (
        <DuplicateTest open={isDuplicateTestDialogOpen} onClose={() => setIsDuplicateTestDialogOpen(false)} testId={selectedTestId} project={project} onTestDuplicated={onTestDuplicated} />
      )}
      {isCloseTestDialogOpen && (
        <CloseTest open={isCloseTestDialogOpen} onClose={() => setIsCloseTestDialogOpen(false)} testId={selectedTestId} onCloseSuccess={refreshTests} />
      )}
    </>
  );
};

export default OpenTestsModal;
